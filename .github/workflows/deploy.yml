name: Deploy to Cloud Run

on:
  push:
    tags:
      - '*.*.*-dev'       # dev
      - '*.*.*-sandbox'   # sandbox
      - '*.*.*'           # prod (default)

jobs:
  # ────────────────────────────────────────────────
  # 1. API Service (Python)
  # ────────────────────────────────────────────────
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Env Vars
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          if [[ "$VERSION" == *"-dev" ]]; then echo "ENVIRONMENT=dev" >> "$GITHUB_ENV";
          elif [[ "$VERSION" == *"-sandbox" ]]; then echo "ENVIRONMENT=sandbox" >> "$GITHUB_ENV";
          else echo "ENVIRONMENT=prod" >> "$GITHUB_ENV"; fi

      - name: Authenticate with GCP
        run: |
          echo "${{ secrets.GCP_SA_KEY }}" | base64 --decode > gcp-key.json
          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project "${{ secrets.GCP_PROJECT }}"

      - name: Build & Push API Image
        run: |
          cd backend
          IMAGE_URI="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/ofta-repo/ofta-api:${{ env.VERSION }}"
          gcloud builds submit --tag "$IMAGE_URI"

      - name: Deploy API
        run: |
          SERVICE="ofta-api-${{ env.ENVIRONMENT }}"
          IMAGE_URI="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/ofta-repo/ofta-api:${{ env.VERSION }}"
          gcloud run deploy "$SERVICE" \
            --image="$IMAGE_URI" \
            --region=us-central1 \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars "\
              OFTA_DB_HOST=${{ secrets.OFTA_DB_HOST }},\
              OFTA_DB_PORT=${{ secrets.OFTA_DB_PORT }},\
              OFTA_DB_NAME=${{ secrets.OFTA_DB_NAME }},\
              OFTA_DB_USERNAME=${{ secrets.OFTA_DB_USERNAME }},\
              OFTA_DB_PASSWORD=${{ secrets.OFTA_DB_PASSWORD }},\
              SECRET_KEY=${{ secrets.SECRET_KEY }},\
              JWT_SECRET=${{ secrets.JWT_SECRET }},\
              FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }},\
              GOOGLE_CLOUD_PROJECT=${{ secrets.GCP_PROJECT }},\
              OFTA_STORAGE_BUCKET=${{ secrets.OFTA_STORAGE_BUCKET }},\
              ENVIRONMENT=${{ env.ENVIRONMENT }}"

  # ────────────────────────────────────────────────
  # 2. Admin Panel (Static/Nginx)
  # ────────────────────────────────────────────────
  deploy-admin:
    needs: deploy-api # Wait so we can inject the API URL if needed
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Env Vars
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          if [[ "$VERSION" == *"-dev" ]]; then echo "ENVIRONMENT=dev" >> "$GITHUB_ENV";
          elif [[ "$VERSION" == *"-sandbox" ]]; then echo "ENVIRONMENT=sandbox" >> "$GITHUB_ENV";
          else echo "ENVIRONMENT=prod" >> "$GITHUB_ENV"; fi

      - name: Authenticate with GCP
        run: |
          echo "${{ secrets.GCP_SA_KEY }}" | base64 --decode > gcp-key.json
          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project "${{ secrets.GCP_PROJECT }}"

      - name: Build & Push Admin Image
        run: |
          cd admin
          IMAGE_URI="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/ofta-repo/ofta-admin:${{ env.VERSION }}"
          gcloud builds submit --tag "$IMAGE_URI"

      - name: Deploy Admin
        run: |
          SERVICE="ofta-admin-${{ env.ENVIRONMENT }}"
          IMAGE_URI="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/ofta-repo/ofta-admin:${{ env.VERSION }}"
          # Determine API URL based on environment (you can hardcode or use output from previous step)
          # For now assuming standard pattern:
          API_URL="https://ofta-api-${{ env.ENVIRONMENT }}-xyz-uc.a.run.app"
          
          gcloud run deploy "$SERVICE" \
            --image="$IMAGE_URI" \
            --region=us-central1 \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars "API_BASE_URL=$API_URL"

  # ────────────────────────────────────────────────
  # 3. Mobile App (Web Version)
  # ────────────────────────────────────────────────
  deploy-web-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Env Vars
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          if [[ "$VERSION" == *"-dev" ]]; then echo "ENVIRONMENT=dev" >> "$GITHUB_ENV";
          elif [[ "$VERSION" == *"-sandbox" ]]; then echo "ENVIRONMENT=sandbox" >> "$GITHUB_ENV";
          else echo "ENVIRONMENT=prod" >> "$GITHUB_ENV"; fi

      - name: Authenticate with GCP
        run: |
          echo "${{ secrets.GCP_SA_KEY }}" | base64 --decode > gcp-key.json
          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project "${{ secrets.GCP_PROJECT }}"

      - name: Build & Push Web App Image
        run: |
          cd mobile
          IMAGE_URI="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/ofta-repo/ofta-app:${{ env.VERSION }}"
          # Use explicit cloudbuild config to handle build args
          gcloud builds submit --config=cloudbuild.yaml --substitutions=_IMAGE_URI="$IMAGE_URI"

      - name: Deploy Web App
        run: |
          SERVICE="ofta-app-${{ env.ENVIRONMENT }}"
          IMAGE_URI="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/ofta-repo/ofta-app:${{ env.VERSION }}"
          API_URL="https://ofta-api-${{ env.ENVIRONMENT }}-xyz-uc.a.run.app"

          gcloud run deploy "$SERVICE" \
            --image="$IMAGE_URI" \
            --region=us-central1 \
            --platform=managed \
            --allow-unauthenticated \
            --port=3100 \
            --set-env-vars "NEXT_PUBLIC_API_BASE_URL=$API_URL"
